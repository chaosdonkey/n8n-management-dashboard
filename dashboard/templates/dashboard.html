{% extends "base.html" %}

{% block title %}Dashboard - n8n Manager{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()" class="space-y-6">
    <!-- Container Status Card -->
    <div class="bg-slate-800 rounded-lg shadow-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">Container Status</h2>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-400">Version:</span>
                <span class="px-3 py-1 bg-blue-600 text-white rounded-md font-semibold text-sm" x-text="status.current_version || 'unknown'"></span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-400 mb-1">Status</p>
                <p class="text-lg font-semibold">
                    <span :class="{
                        'text-green-400': status.status === 'running',
                        'text-red-400': status.status === 'stopped' || status.status === 'exited',
                        'text-yellow-400': status.status === 'not_found',
                        'text-gray-400': status.status === 'error'
                    }">
                        <span x-text="status.status || 'loading...'"></span>
                    </span>
                </p>
            </div>
            <div>
                <p class="text-sm text-gray-400 mb-1">Current Version</p>
                <p class="text-lg font-semibold text-white" x-text="status.current_version || 'unknown'"></p>
            </div>
            <div>
                <p class="text-sm text-gray-400 mb-1">Started At</p>
                <p class="text-sm text-gray-300" x-text="status.started_at || 'N/A'"></p>
            </div>
            <div>
                <p class="text-sm text-gray-400 mb-1">Health</p>
                <p class="text-sm text-gray-300" x-text="status.health || 'N/A'"></p>
            </div>
            <div x-show="status.cpu_percent !== null && status.cpu_percent !== undefined">
                <p class="text-sm text-gray-400 mb-1">CPU Usage</p>
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-slate-700 rounded-full h-2.5">
                        <div class="bg-blue-500 h-2.5 rounded-full transition-all" :style="'width: ' + Math.min(status.cpu_percent || 0, 100) + '%'"></div>
                    </div>
                    <span class="text-sm font-semibold text-white" x-text="(status.cpu_percent || 0).toFixed(1) + '%'"></span>
                </div>
            </div>
            <div x-show="status.memory_percent !== null && status.memory_percent !== undefined">
                <p class="text-sm text-gray-400 mb-1">Memory Usage</p>
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-slate-700 rounded-full h-2.5">
                        <div class="bg-green-500 h-2.5 rounded-full transition-all" :style="'width: ' + Math.min(status.memory_percent || 0, 100) + '%'"></div>
                    </div>
                    <span class="text-sm font-semibold text-white" x-text="(status.memory_percent || 0).toFixed(1) + '%'"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1" x-show="status.memory_usage && status.memory_limit">
                    <span x-text="formatBytes(status.memory_usage)"></span> / <span x-text="formatBytes(status.memory_limit)"></span>
                </p>
            </div>
        </div>
        <div class="mt-4 flex gap-2 flex-wrap">
            <button
                @click="controlContainer('start')"
                :disabled="status.status === 'running' || loading"
                class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
            >
                Start
            </button>
            <button
                @click="controlContainer('stop')"
                :disabled="status.status !== 'running' || loading"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
            >
                Stop
            </button>
            <button
                @click="controlContainer('restart')"
                :disabled="status.status !== 'running' || loading"
                class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
            >
                Restart
            </button>
            <button
                @click="refreshStatus()"
                :disabled="loading"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
            >
                Refresh
            </button>
            <button
                @click="openN8n()"
                :disabled="status.status !== 'running'"
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:opacity-50 text-white rounded-md transition"
                title="Open n8n in a new tab"
            >
                Open n8n
            </button>
        </div>
    </div>

    <!-- Version Selection Card -->
    <div class="bg-slate-800 rounded-lg shadow-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">Version Upgrade</h2>
        <div class="space-y-4">
            <div>
                <label for="version-select" class="block text-sm font-medium text-gray-300 mb-2">
                    Select Version
                </label>
                <select
                    id="version-select"
                    x-model="selectedVersion"
                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="">-- Select a version --</option>
                    <template x-for="version in versions" :key="version.version">
                        <option :value="version.version">
                            <span x-text="version.version + (version.is_latest === true ? ' (Latest)' : ' (' + version.updated + ')')"></span>
                        </option>
                    </template>
                </select>
            </div>
            
            <div x-show="selectedVersion && selectedVersion !== status.current_version" class="flex gap-2">
                <button
                    @click="checkUpgrade()"
                    :disabled="loading || !selectedVersion"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
                >
                    Check Upgrade
                </button>
                <button
                    @click="performUpgrade()"
                    :disabled="loading || !selectedVersion || !upgradeSafe"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition"
                >
                    Upgrade
                </button>
            </div>

            <div x-show="upgradeWarnings.length > 0" class="p-4 bg-yellow-900 border border-yellow-700 rounded-md">
                <p class="text-yellow-100 font-semibold mb-2">Warnings:</p>
                <ul class="list-disc list-inside text-yellow-200 space-y-1">
                    <template x-for="warning in upgradeWarnings" :key="warning">
                        <li x-text="warning"></li>
                    </template>
                </ul>
            </div>

            <div x-show="upgradeProgress" class="p-4 bg-blue-900 border border-blue-700 rounded-md">
                <p class="text-blue-100" x-text="upgradeProgress"></p>
            </div>
        </div>
    </div>

    <!-- Local Images Card -->
    <div class="bg-slate-800 rounded-lg shadow-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">Local Images</h2>
        <div class="space-y-2">
            <template x-for="(image, index) in localImages" :key="'image-' + index + '-' + image.version">
                <div class="flex items-center justify-between p-3 bg-slate-700 rounded-md">
                    <div>
                        <p class="text-white font-medium" x-text="image.version"></p>
                        <p class="text-sm text-gray-400" x-text="'Created: ' + (image.created || 'N/A')"></p>
                    </div>
                    <button
                        x-show="getRollbackIndex() === index && image.version !== status.current_version"
                        @click="rollback()"
                        :disabled="loading"
                        class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition text-sm"
                    >
                        Rollback
                    </button>
                </div>
            </template>
            <p x-show="!localImages || localImages.length === 0" class="text-gray-400">No local images found</p>
            <div x-show="localImages && localImages.length > 0" class="text-xs text-gray-500 mt-2">
                <span x-text="'Total: ' + localImages.length + ' image(s)'"></span>
            </div>
        </div>
    </div>

    <!-- Modal for alerts and confirmations -->
    <div x-show="modal.show" 
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
         @click.self="modal.show = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-md w-full mx-4"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4" x-text="modal.title"></h3>
                <p class="text-gray-300 mb-6" x-text="modal.message"></p>
                <div class="flex justify-end gap-3">
                    <template x-if="modal.type === 'confirm'">
                        <button
                            @click="modal.onCancel && modal.onCancel(); modal.show = false"
                            class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-md transition"
                        >
                            Cancel
                        </button>
                    </template>
                    <button
                        @click="modal.onConfirm && modal.onConfirm(); modal.show = false"
                        :class="{
                            'bg-blue-600 hover:bg-blue-700': modal.type === 'alert',
                            'bg-green-600 hover:bg-green-700': modal.type === 'confirm'
                        }"
                        class="px-4 py-2 text-white rounded-md transition"
                        x-text="modal.type === 'confirm' ? 'Confirm' : 'OK'"
                    >
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        status: {{ status | tojson }},
        versions: {{ versions | tojson }},
        localImages: {{ local_images | tojson }} || [],
        selectedVersion: '',
        upgradeSafe: false,
        upgradeWarnings: [],
        upgradeProgress: '',
        loading: false,
        refreshing: false,
        modal: {
            show: false,
            type: 'alert', // 'alert' or 'confirm'
            title: '',
            message: '',
            onConfirm: null,
            onCancel: null
        },

        init() {
            // Ensure localImages is an array
            if (!Array.isArray(this.localImages)) {
                console.log('Initializing localImages as empty array, current value:', this.localImages);
                this.localImages = [];
            } else {
                console.log('localImages already initialized with', this.localImages.length, 'items');
            }
            // Load local images on init
            this.loadLocalImages();
            // Use $nextTick to ensure DOM is ready before setting selection
            this.$nextTick(() => {
                this.setCurrentVersionAsSelected();
            });
            this.refreshStatus();
            // Auto-refresh status every 5 seconds to update CPU/memory
            setInterval(() => {
                if (!this.loading && !this.refreshing) {
                    this.refreshStatus();
                }
            }, 5000);
        },

        async loadLocalImages() {
            try {
                const response = await fetch('/api/local-images');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Local images API response:', data);
                    if (Array.isArray(data)) {
                        this.localImages = data;
                        console.log('Loaded local images:', this.localImages.length, this.localImages);
                    } else {
                        console.error('Local images data is not an array:', typeof data, data);
                        this.localImages = [];
                    }
                } else {
                    console.error('Failed to fetch local images:', response.status, response.statusText);
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error details:', errorData);
                }
            } catch (error) {
                console.error('Error loading local images:', error);
                this.localImages = [];
            }
        },

        getRollbackIndex() {
            // Find the first image that is different from current version
            // This will be the image we can rollback to
            if (!this.localImages || !Array.isArray(this.localImages) || !this.status?.current_version) {
                return -1;
            }
            
            const currentVersion = this.status.current_version;
            
            // Try index 1 first (second-newest, which is what rollback_to_previous uses)
            // But only if it's different from current version
            if (this.localImages.length > 1) {
                const secondImage = this.localImages[1];
                if (secondImage && secondImage.version !== currentVersion) {
                    return 1;
                }
            }
            
            // If index 1 is current version, find first different version (skip index 0 if it's also current)
            for (let i = 0; i < this.localImages.length; i++) {
                if (this.localImages[i].version !== currentVersion) {
                    return i;
                }
            }
            
            return -1; // No rollback available
        },

        setCurrentVersionAsSelected() {
            // Always set selected version to current version if it exists
            if (this.status?.current_version) {
                const currentVersion = this.status.current_version;
                // Check if version exists in versions list (if versions are loaded)
                if (this.versions?.length > 0) {
                    const versionExists = this.versions.some(v => v.version === currentVersion);
                    if (versionExists) {
                        this.selectedVersion = currentVersion;
                        console.log('Set selectedVersion to:', currentVersion);
                    } else {
                        // Current version not in list, but set it anyway so user can see what's running
                        this.selectedVersion = currentVersion;
                        console.log('Set selectedVersion to (not in list):', currentVersion);
                    }
                } else {
                    // Versions not loaded yet, set it anyway
                    this.selectedVersion = currentVersion;
                    console.log('Set selectedVersion to (versions not loaded):', currentVersion);
                }
            } else {
                console.log('No current_version in status');
            }
        },

        formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        },

        showAlert(title, message) {
            this.modal = {
                show: true,
                type: 'alert',
                title: title,
                message: message,
                onConfirm: null,
                onCancel: null
            };
        },

        showConfirm(title, message, onConfirm, onCancel) {
            this.modal = {
                show: true,
                type: 'confirm',
                title: title,
                message: message,
                onConfirm: onConfirm || (() => {}),
                onCancel: onCancel || (() => {})
            };
        },

        async refreshStatus() {
            // Use a separate flag for background refreshes to prevent button flickering
            const isBackgroundRefresh = !this.loading;
            if (isBackgroundRefresh) {
                this.refreshing = true;
            } else {
                this.loading = true;
            }
            
            // Store current selection to preserve it after refresh (only for background refreshes)
            const currentSelection = this.selectedVersion;
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                const previousVersion = this.status?.current_version;
                this.status = data;
                
                // Also refresh local images if this is not a background refresh
                if (!isBackgroundRefresh) {
                    try {
                        const localImagesResponse = await fetch('/api/local-images');
                        if (localImagesResponse.ok) {
                            const localImagesData = await localImagesResponse.json();
                            if (Array.isArray(localImagesData)) {
                                this.localImages = localImagesData;
                            }
                        }
                    } catch (error) {
                        console.error('Error refreshing local images:', error);
                    }
                }
                
                // If the version changed (e.g., after upgrade/rollback), set to new current version
                if (previousVersion && previousVersion !== data.current_version) {
                    this.setCurrentVersionAsSelected();
                    this.upgradeSafe = false;
                    this.upgradeWarnings = [];
                } else if (isBackgroundRefresh) {
                    // For background refreshes, preserve user selection if they've chosen a different version
                    // Otherwise, set to current version if it exists in the list
                    if (!currentSelection || currentSelection === previousVersion) {
                        this.setCurrentVersionAsSelected();
                    } else {
                        // User has selected a different version, preserve their selection
                        this.selectedVersion = currentSelection;
                    }
                } else {
                    // For non-background refreshes, set to current version if no selection and it exists in list
                    if (!currentSelection) {
                        this.setCurrentVersionAsSelected();
                    }
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
            } finally {
                if (isBackgroundRefresh) {
                    this.refreshing = false;
                } else {
                    this.loading = false;
                }
            }
        },

        async controlContainer(action) {
            this.loading = true;
            try {
                const response = await fetch(`/api/control/${action}`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    setTimeout(() => this.refreshStatus(), 1000);
                } else {
                    this.showAlert('Error', data.error || 'Unknown error');
                }
            } catch (error) {
                this.showAlert('Error', error.message);
            } finally {
                this.loading = false;
            }
        },

        async checkUpgrade() {
            if (!this.selectedVersion) return;
            
            this.loading = true;
            this.upgradeWarnings = [];
            this.upgradeSafe = false;
            
            try {
                const response = await fetch('/api/check-upgrade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_version: this.selectedVersion
                    })
                });
                const data = await response.json();
                
                if (data.error) {
                    this.showAlert('Error', data.error);
                } else {
                    this.upgradeSafe = data.safe;
                    this.upgradeWarnings = data.warnings || [];
                }
            } catch (error) {
                this.showAlert('Error', error.message);
            } finally {
                this.loading = false;
            }
        },

        async performUpgrade() {
            if (!this.selectedVersion || !this.upgradeSafe) return;
            
            this.showConfirm(
                'Confirm Upgrade',
                `Are you sure you want to upgrade to version ${this.selectedVersion}? A backup will be created automatically.`,
                () => {
                    this.loading = true;
                    this.upgradeProgress = 'Creating backup...';
                    
                    fetch('/api/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            target_version: this.selectedVersion
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            this.showAlert('Error', data.error);
                            this.upgradeProgress = '';
                        } else {
                            this.upgradeProgress = 'Upgrade successful! Refreshing...';
                            // Clear upgrade state, but selectedVersion will be set to new current version by refreshStatus
                            this.upgradeSafe = false;
                            this.upgradeWarnings = [];
                            setTimeout(() => {
                                this.refreshStatus();
                                this.upgradeProgress = '';
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        this.showAlert('Error', error.message);
                        this.upgradeProgress = '';
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                }
            );
        },

        async rollback() {
            this.showConfirm(
                'Confirm Rollback',
                'Are you sure you want to rollback to the previous version? A backup will be created automatically.',
                () => {
                    this.loading = true;
                    this.upgradeProgress = 'Rolling back...';
                    
                    fetch('/api/rollback', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            this.showAlert('Error', data.error);
                            this.upgradeProgress = '';
                        } else {
                            this.upgradeProgress = 'Rollback successful! Refreshing...';
                            // Clear upgrade state, but selectedVersion will be set to new current version by refreshStatus
                            this.upgradeSafe = false;
                            this.upgradeWarnings = [];
                            setTimeout(() => {
                                this.refreshStatus();
                                this.upgradeProgress = '';
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        this.showAlert('Error', error.message);
                        this.upgradeProgress = '';
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                }
            );
        },

        openN8n() {
            if (this.status.status === 'running') {
                window.open('http://localhost:5678', '_blank');
            }
        }
    }
}
</script>
{% endblock %}

